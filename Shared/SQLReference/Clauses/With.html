<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" class="reference" data-mc-search-type="Stem" data-mc-help-system-file-name="index.xml" data-mc-path-to-help-system="../../../" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="SQL Reference|Clauses">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="description" content="The WITH clause is also known as the subquery refactoring clause, and is used to name a subquery, which improves readability and can improve query efficiency. " /><title>WITH clause
</title>
        <link href="../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" data-mc-generated="True" />
        <link href="../../../Resources/Stylesheets/SpliceTriPaneStyles.css" rel="stylesheet" />
        <script src="../../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../../Resources/Scripts/foundation.min.js">
        </script>
        <script src="../../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../../Resources/Scripts/MadCapAll.js">
        </script>
    </head>
    <body>
        <p class="MCWebHelpFramesetLink MCWebHelpFramesetLinkTop"><a href="../../../index.html#Shared/SQLReference/Clauses/With.html">Open topic with navigation</a>
        </p>
        <div class="TopicContent">
            <h1><a name="kanchor37"></a>WITH CLAUSE&#160;(Common Table Expression)</h1>
            <p>You can use Common Table Expressions, also known as the <span class="CodeFont">WITH</span> clause, to break down complicated queries into simpler parts by naming and referring to subqueries within queries. </p>
            <p>A Common Table Expression (CTE)&#160;provides a way of defining a temporary result set whose definition is available only to the query in which the CTE is defined.  The result of the CTE is not stored; it exists only for the duration of the query. 
CTEs are helpful in reducing query complexity and increasing readability.  They can be used as substitutions for views in cases where either you donâ€™t have permission to create a view or the query would be the only one using the view.  CTEs allow you to more easily enable grouping by a column that is derived from a scalar sub select or a function that is non deterministic.
</p>
            <p class="noteNote" data-mc-autonum="NOTE: &#160;"><span class="autonumber"><span class="noteAutoNum">NOTE: &#160;</span></span>The <span class="CodeFont">WITH</span> clause is also known as the <span class="ItalicFont">subquery factoring clause</span>.

</p>
            <p>The handling and syntax of <span class="CodeFont">WITH</span> queries are similar to the handling and syntax of views. The <span class="CodeFont">WITH</span> clause can be processed as an inline view and shares syntax with <span class="CodeFont">CREATE VIEW</span>. The <span class="CodeFont">WITH</span> clause can also resolve as a temporary table, which may enhance the efficiency of a query.</p>
            <p class="heading2">Syntax</p>
            <div class="preWrapper"><pre class="FcnSyntax">WITH <span class="ItalicFont">queryName</span> <br /> &#160;&#160;AS SELECT&#160;<span class="ItalicFont"><a href="../Expressions/Select.html">SelectExpr</a></span><br />SELECT&#160;<span class="ItalicFont"><a href="../Queries/Query.html">Query</a></span></pre>
            </div>
            <div class="paramList">
                <p class="paramName">queryName</p>
                <p class="paramDefnFirst">An identifier that names the subquery clause.</p>
            </div>
            <p class="heading2">Examples</p>
            <p class="body">If we create the following table:</p>
            <div class="preWrapperWide"><pre class="Example">CREATE TABLE BANKS (
&#160;&#160;&#160;&#160;&#160;&#160;&#160;INSTITUTION_ID INTEGER NOT NULL,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;INSTITUTION_NAME VARCHAR(100),
&#160;&#160;&#160;&#160;&#160;&#160;&#160;CITY VARCHAR(100),
&#160;&#160;&#160;&#160;&#160;&#160;&#160;STATE VARCHAR(2),
&#160;&#160;&#160;&#160;&#160;&#160;&#160;TOTAL_ASSETS DECIMAL(19,2),
&#160;&#160;&#160;&#160;&#160;&#160;&#160;NET_INCOME DECIMAL(19,2),
&#160;&#160;&#160;&#160;&#160;&#160;&#160;OFFICES INTEGER,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;PRIMARY KEY(INSTITUTION_ID)
);</pre>
            </div>
            <p class="body">We can then use a common table expression to improve the readability of a statement that finds the per-city total assets and income for the states with the top net income:</p>
            <div class="preWrapperWide"><pre class="Example">WITH state_sales AS (
&#160;&#160;&#160;&#160;&#160;&#160;&#160;SELECT STATE, SUM(NET_INCOME) AS total_sales
&#160;&#160;&#160;&#160;&#160;&#160;&#160;FROM INSTITUTIONS
&#160;&#160;&#160;&#160;&#160;&#160;&#160;GROUP BY STATE
   ), top_states AS (
&#160;&#160;&#160;&#160;&#160;&#160;&#160;SELECT STATE
&#160;&#160;&#160;&#160;&#160;&#160;&#160;FROM state_sales
&#160;&#160;&#160;&#160;&#160;&#160;&#160;WHERE total_sales &gt; (SELECT SUM(total_sales)/10 FROM state_sales)
   )
SELECT STATE,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;CITY,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;SUM(TOTAL_ASSETS) AS assets,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;SUM(NET_INCOME) AS income
FROM INSTITUTIONS
WHERE STATE IN (SELECT STATE FROM top_states)
GROUP BY STATE, CITY;
</pre>
            </div>
            <p class="heading2">See Also</p>
            <ul>
                <li value="1"><a href="../Expressions/Select.html"><span class="CodeFont">SELECT</span></a> expression</li>
                <li value="2"><a href="../Queries/Query.html"><span class="CodeFont">Query</span></a>&#160;</li>
            </ul>
            <div class="hiddenText">WITH</div>
            <p style="font-size: 6pt;margin-top: 0;margin-bottom: 0;">&#160;</p>
        </div>
    </body>
</html>